<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BaseballBinder Pro - Professional digital baseball card collection management platform">
    <meta name="keywords" content="baseball cards, card collection, baseball binder, sports cards, trading cards, collection manager">
    <title>BaseballBinder Pro - Digital Card Collection Manager</title>

    <!-- Inter Font Family -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* BaseballBinder Pro Color Palette */
            --bb-primary: #8C1D40;
            --bb-primary-hover: #6D1632;
            --bb-primary-light: #A82950;
            --bb-secondary: #1E1E24;
            --bb-secondary-light: #2A2A32;
            --bb-accent: #F4EBD0;
            --bb-neutral: #A9A9B3;
            --bb-highlight: #2F4E78;
            --bb-highlight-hover: #243D5E;

            /* Semantic Colors */
            --bb-success: #24A148;
            --bb-error: #DA1E28;
            --bb-warning: #F1C21B;
            --bb-info: #0F62FE;

            /* Background System */
            --bb-bg-primary: #121216;
            --bb-bg-secondary: #1E1E24;
            --bb-bg-tertiary: #2A2A32;
            --bb-bg-elevated: #353540;

            /* Text System */
            --bb-text-primary: #F4EBD0;
            --bb-text-secondary: #A9A9B3;
            --bb-text-tertiary: #6B6B76;
            --bb-text-inverse: #121216;

            /* Border System */
            --bb-border-subtle: rgba(169, 169, 179, 0.15);
            --bb-border-medium: rgba(169, 169, 179, 0.25);
            --bb-border-strong: rgba(169, 169, 179, 0.35);

            /* Spacing Scale */
            --spacing-1: 4px;
            --spacing-2: 8px;
            --spacing-3: 12px;
            --spacing-4: 16px;
            --spacing-5: 20px;
            --spacing-6: 24px;
            --spacing-8: 32px;
            --spacing-10: 40px;
            --spacing-12: 48px;
            --spacing-16: 64px;

            /* Typography Scale */
            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-md: 1.125rem;
            --font-lg: 1.25rem;
            --font-xl: 1.5rem;
            --font-2xl: 1.875rem;
            --font-3xl: 2.25rem;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.35);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 200ms ease;
            --transition-slow: 300ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bb-bg-primary);
            min-height: 100vh;
            color: var(--bb-text-primary);
            font-size: var(--font-base);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ================================
           NAVIGATION
           ================================ */
        .navbar {
            background: var(--bb-bg-secondary);
            border-bottom: 1px solid var(--bb-border-subtle);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--bb-text-primary);
            letter-spacing: -0.02em;
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            background: var(--bb-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-sm);
            color: white;
        }

        .nav-links {
            display: flex;
            gap: var(--spacing-2);
            list-style: none;
            align-items: center;
        }

        .nav-link {
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: 500;
            font-size: var(--font-sm);
            color: var(--bb-text-secondary);
            white-space: nowrap;
        }

        .nav-link:hover {
            background: var(--bb-bg-tertiary);
            color: var(--bb-text-primary);
        }

        .nav-link.active {
            background: var(--bb-highlight);
            color: var(--bb-accent);
        }

        .nav-link:focus-visible {
            outline: 2px solid var(--bb-primary);
            outline-offset: 2px;
        }

        /* ================================
           LAYOUT
           ================================ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-8) var(--spacing-6);
        }

        .page {
            display: none;
            animation: fadeIn var(--transition-base);
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================================
           CARDS & CONTENT
           ================================ */
        .content-card {
            background: var(--bb-bg-secondary);
            border: 1px solid var(--bb-border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-6);
        }

        .content-card h2 {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-4);
            letter-spacing: -0.02em;
        }

        .content-card h3 {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-3);
        }

        /* ================================
           STAT CARDS
           ================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }

        .stat-card {
            background: var(--bb-bg-tertiary);
            border: 1px solid var(--bb-border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--spacing-5);
            transition: border-color var(--transition-fast);
        }

        .stat-card:hover {
            border-color: var(--bb-border-medium);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-3);
        }

        .stat-label {
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--bb-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: var(--font-2xl);
            font-weight: 700;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-2);
            letter-spacing: -0.02em;
        }

        .stat-change {
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--bb-text-tertiary);
        }

        .stat-change.positive {
            color: var(--bb-success);
        }

        .stat-change.negative {
            color: var(--bb-error);
        }

        /* Insight Cards */
        .insight-card {
            background: linear-gradient(135deg, var(--bb-primary) 0%, var(--bb-primary-hover) 100%);
            border: none;
        }

        .insight-card .stat-label,
        .insight-card .stat-value,
        .insight-card .stat-change {
            color: var(--bb-accent);
        }

        /* ================================
           BUTTONS
           ================================ */
        .btn {
            padding: var(--spacing-3) var(--spacing-5);
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            white-space: nowrap;
        }

        .btn:focus-visible {
            outline: 2px solid var(--bb-primary);
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--bb-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--bb-primary-hover);
        }

        .btn-secondary {
            background: var(--bb-bg-tertiary);
            color: var(--bb-text-primary);
            border: 1px solid var(--bb-border-medium);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bb-bg-elevated);
            border-color: var(--bb-border-strong);
        }

        .btn-success {
            background: var(--bb-success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #1a7a37;
        }

        .btn-danger {
            background: var(--bb-error);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #a71a22;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: var(--spacing-2) var(--spacing-3);
            font-size: var(--font-xs);
        }

        /* ================================
           FORMS
           ================================ */
        .form-group {
            margin-bottom: var(--spacing-5);
        }

        .form-label {
            display: block;
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-2);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-3);
            background: var(--bb-bg-tertiary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-md);
            color: var(--bb-text-primary);
            font-size: var(--font-sm);
            font-family: inherit;
            transition: border-color var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--bb-primary);
        }

        .form-input::placeholder {
            color: var(--bb-text-tertiary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            cursor: pointer;
        }

        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ================================
           TABLES
           ================================ */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--bb-border-subtle);
            border-radius: var(--radius-lg);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-sm);
        }

        .data-table thead {
            background: var(--bb-bg-tertiary);
            border-bottom: 1px solid var(--bb-border-medium);
        }

        .data-table th {
            padding: var(--spacing-4);
            text-align: left;
            font-weight: 600;
            color: var(--bb-text-primary);
            font-size: var(--font-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: var(--spacing-4);
            border-top: 1px solid var(--bb-border-subtle);
            color: var(--bb-text-secondary);
        }

        .data-table tbody tr {
            transition: background-color var(--transition-fast);
        }

        .data-table tbody tr:hover {
            background: var(--bb-bg-tertiary);
        }

        /* ================================
           MODALS
           ================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-6);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bb-bg-secondary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--bb-border-subtle);
        }

        .modal-header h2 {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--bb-text-primary);
        }

        .modal-body {
            padding: var(--spacing-6);
            overflow-y: auto;
        }

        .modal-footer {
            padding: var(--spacing-6);
            border-top: 1px solid var(--bb-border-subtle);
            display: flex;
            gap: var(--spacing-3);
            justify-content: flex-end;
        }

        /* ================================
           UTILITIES
           ================================ */
        .empty-state {
            text-align: center;
            padding: var(--spacing-10);
            color: var(--bb-text-tertiary);
        }

        .empty-state-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--bb-text-secondary);
            margin-bottom: var(--spacing-2);
        }

        .loading {
            text-align: center;
            padding: var(--spacing-10);
            color: var(--bb-text-tertiary);
        }

        .spinner {
            border: 3px solid var(--bb-border-subtle);
            border-top-color: var(--bb-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--spacing-4);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message/Toast */
        .message-container {
            position: fixed;
            top: 80px;
            right: var(--spacing-6);
            z-index: 3000;
            max-width: 400px;
        }

        .message {
            background: var(--bb-bg-secondary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-3);
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            border-left: 4px solid var(--bb-success);
        }

        .message.error {
            border-left: 4px solid var(--bb-error);
        }

        /* ================================
           PAGE-SPECIFIC STYLES
           ================================ */

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, var(--bb-secondary) 0%, var(--bb-bg-primary) 100%);
            border: 1px solid var(--bb-border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--spacing-12) var(--spacing-8);
            text-align: center;
            margin-bottom: var(--spacing-8);
        }

        .hero-title {
            font-size: var(--font-3xl);
            font-weight: 700;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-3);
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: var(--font-md);
            color: var(--bb-text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Tab System */
        .tab-buttons {
            display: flex;
            gap: var(--spacing-2);
            border-bottom: 1px solid var(--bb-border-subtle);
            margin-bottom: var(--spacing-6);
        }

        .tab-button {
            padding: var(--spacing-3) var(--spacing-5);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--bb-text-secondary);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .tab-button:hover {
            color: var(--bb-text-primary);
        }

        .tab-button.active {
            color: var(--bb-primary);
            border-bottom-color: var(--bb-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Import Preview */
        .import-preview {
            background: var(--bb-bg-tertiary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            margin: var(--spacing-4) 0;
        }

        .import-stats {
            display: flex;
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-4);
        }

        .import-stat {
            font-size: var(--font-sm);
            color: var(--bb-text-secondary);
        }

        .import-stat strong {
            color: var(--bb-text-primary);
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-bar-container {
            background: var(--bb-bg-tertiary);
            border-radius: var(--radius-md);
            height: 32px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            background: var(--bb-primary);
            height: 100%;
            transition: width var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-sm);
            font-weight: 600;
        }

        /* Card Grid (for selection modal) */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-3);
            max-height: 400px;
            overflow-y: auto;
        }

        .card-item {
            background: var(--bb-bg-tertiary);
            border: 2px solid var(--bb-border-subtle);
            border-radius: var(--radius-md);
            padding: var(--spacing-3);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .card-item:hover {
            border-color: var(--bb-border-medium);
        }

        /* Grouped Collection Views */
        .group-container {
            margin-bottom: var(--spacing-4);
        }

        .group-header {
            background: var(--bb-bg-tertiary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-header:hover {
            background: var(--bb-bg-elevated);
            border-color: var(--bb-border-strong);
        }

        .group-header.expanded {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: transparent;
        }

        .group-title {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--bb-text-primary);
        }

        .group-meta {
            display: flex;
            gap: var(--spacing-6);
            align-items: center;
            font-size: var(--font-sm);
            color: var(--bb-text-secondary);
        }

        .group-stat {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .group-stat-value {
            font-weight: 600;
            color: var(--bb-text-primary);
        }

        .group-expand-icon {
            font-size: var(--font-lg);
            color: var(--bb-text-secondary);
            transition: transform var(--transition-fast);
        }

        .group-header.expanded .group-expand-icon {
            transform: rotate(90deg);
        }

        .group-content {
            display: none;
            border: 1px solid var(--bb-border-medium);
            border-top: none;
            border-bottom-left-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
            overflow: hidden;
        }

        .group-content.expanded {
            display: block;
        }

        /* Compact View */
        .compact-card-list {
            padding: var(--spacing-2);
        }

        .compact-card {
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--bb-border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background var(--transition-fast);
        }

        .compact-card:hover {
            background: var(--bb-bg-tertiary);
        }

        .compact-card:last-child {
            border-bottom: none;
        }

        .compact-card-info {
            flex: 1;
            font-size: var(--font-sm);
        }

        .compact-card-title {
            font-weight: 600;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-1);
        }

        .compact-card-details {
            color: var(--bb-text-secondary);
            font-size: var(--font-xs);
        }

        .compact-card-value {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--bb-text-primary);
            margin-right: var(--spacing-4);
        }

        .compact-card-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        /* Card View (Visual Grid) */
        .card-view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-4);
            padding: var(--spacing-4);
        }

        .visual-card {
            background: var(--bb-bg-tertiary);
            border: 1px solid var(--bb-border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            transition: all var(--transition-fast);
        }

        .visual-card:hover {
            border-color: var(--bb-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .visual-card-header {
            margin-bottom: var(--spacing-3);
            padding-bottom: var(--spacing-3);
            border-bottom: 1px solid var(--bb-border-subtle);
        }

        .visual-card-player {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-1);
        }

        .visual-card-set {
            font-size: var(--font-sm);
            color: var(--bb-text-secondary);
        }

        .visual-card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-3);
            font-size: var(--font-xs);
        }

        .visual-card-detail {
            display: flex;
            justify-content: space-between;
        }

        .visual-card-detail-label {
            color: var(--bb-text-tertiary);
        }

        .visual-card-detail-value {
            color: var(--bb-text-primary);
            font-weight: 600;
        }

        .visual-card-value {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--bb-primary);
            margin-bottom: var(--spacing-3);
        }

        .visual-card-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        .card-item.selected {
            border-color: var(--bb-primary);
            background: var(--bb-primary-light);
        }

        .card-item-title {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--bb-text-primary);
            margin-bottom: var(--spacing-1);
        }

        .card-item-subtitle {
            font-size: var(--font-xs);
            color: var(--bb-text-tertiary);
        }

        /* Search */
        .search-container {
            position: relative;
            margin-bottom: var(--spacing-4);
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-10) var(--spacing-3) var(--spacing-4);
            background: var(--bb-bg-tertiary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-md);
            color: var(--bb-text-primary);
            font-size: var(--font-sm);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--bb-primary);
        }

        .search-clear {
            position: absolute;
            right: var(--spacing-3);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--bb-text-tertiary);
            cursor: pointer;
            padding: var(--spacing-2);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bb-bg-secondary);
            border: 1px solid var(--bb-border-medium);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .suggestion-item {
            padding: var(--spacing-3);
            cursor: pointer;
            transition: background var(--transition-fast);
            font-size: var(--font-sm);
            color: var(--bb-text-secondary);
        }

        .suggestion-item:hover {
            background: var(--bb-bg-tertiary);
            color: var(--bb-text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-4);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                gap: var(--spacing-1);
            }

            .nav-link {
                padding: var(--spacing-2);
                font-size: var(--font-xs);
            }

            .hero-section {
                padding: var(--spacing-8) var(--spacing-4);
            }

            .hero-title {
                font-size: var(--font-2xl);
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="brand-logo">BB</div>
                <span>BaseballBinder Pro</span>
            </div>
            <div class="nav-links">
                <div class="nav-link active" onclick="showPage('home', event)">Dashboard</div>
                <div class="nav-link" onclick="showPage('import', event)">Import</div>
                <div class="nav-link" onclick="showPage('add', event)">Add Card</div>
                <div class="nav-link" onclick="showPage('collection', event)">Collection</div>
                <div class="nav-link" onclick="showPage('pricing', event)">Pricing</div>
                <div class="nav-link" onclick="showPage('suggestions', event)">Feedback</div>
                <div class="nav-link" onclick="showPage('admin', event)">Admin</div>
            </div>
        </div>
    </nav>

    <!-- Message Container -->
    <div id="messageContainer" class="message-container"></div>

    <!-- HOME PAGE -->
    <div id="page-home" class="page active">
        <div class="container">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="hero-title">Your Digital Card Collection</h1>
                <p class="hero-subtitle">Professional card collection management with real-time pricing and analytics</p>
            </div>

            <!-- Main Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Total Cards</span>
                    </div>
                    <div class="stat-value" id="homeTotalCards">0</div>
                    <div class="stat-change">Cards in collection</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Total Invested</span>
                    </div>
                    <div class="stat-value" id="homeTotalInvested">$0</div>
                    <div class="stat-change">Amount spent</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Current Value</span>
                    </div>
                    <div class="stat-value" id="homeTotalValue">$0</div>
                    <div class="stat-change">Market value</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Profit/Loss</span>
                    </div>
                    <div class="stat-value" id="homeProfitLoss">$0</div>
                    <div class="stat-change" id="homeProfitLossChange">No change</div>
                </div>
            </div>

            <!-- Collection Insights -->
            <div class="content-card">
                <h3>Collection Insights</h3>
                <div class="stats-grid">
                    <div class="stat-card insight-card">
                        <div class="stat-header">
                            <span class="stat-label">Top Player</span>
                        </div>
                        <div class="stat-value" id="topPlayer">—</div>
                        <div class="stat-change" id="topPlayerCount">0 cards</div>
                    </div>

                    <div class="stat-card insight-card">
                        <div class="stat-header">
                            <span class="stat-label">Top Team</span>
                        </div>
                        <div class="stat-value" id="topTeam">—</div>
                        <div class="stat-change" id="topTeamCount">0 cards</div>
                    </div>

                    <div class="stat-card insight-card">
                        <div class="stat-header">
                            <span class="stat-label">Top Set</span>
                        </div>
                        <div class="stat-value" id="topSet">—</div>
                        <div class="stat-change" id="topSetCount">0 cards</div>
                    </div>

                    <div class="stat-card insight-card">
                        <div class="stat-header">
                            <span class="stat-label">Most Valuable</span>
                        </div>
                        <div class="stat-value" id="mostValuableCard">—</div>
                        <div class="stat-change" id="mostValuableValue">$0</div>
                    </div>

                    <div class="stat-card insight-card">
                        <div class="stat-header">
                            <span class="stat-label">Average Value</span>
                        </div>
                        <div class="stat-value" id="avgCardValue">$0</div>
                        <div class="stat-change">Per card</div>
                    </div>

                    <div class="stat-card insight-card">
                        <div class="stat-header">
                            <span class="stat-label">Autographs</span>
                        </div>
                        <div class="stat-value" id="totalAutographs">0</div>
                        <div class="stat-change" id="autographPercent">0% of collection</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT PAGE -->
    <div id="page-import" class="page">
        <div class="container">
            <div class="content-card">
                <h2>Import Data</h2>

                <div class="tab-buttons">
                    <button id="tab-checklists" class="tab-button active" onclick="switchImportTab('checklists')">Checklists</button>
                    <button id="tab-cards" class="tab-button" onclick="switchImportTab('cards')">Cards (CSV)</button>
                </div>

                <!-- Checklist Import Tab -->
                <div id="import-tab-checklists" class="tab-content active">
                    <p style="color: var(--bb-text-secondary); margin-bottom: var(--spacing-6);">Manage and import baseball card checklists from CSV files</p>

                    <div style="display: flex; gap: var(--spacing-3); margin-bottom: var(--spacing-6);">
                        <button class="btn btn-primary" onclick="rescanChecklists()">Rescan Folder</button>
                        <button class="btn btn-secondary" onclick="openRequestChecklistModal()">Request Checklist</button>
                    </div>

                    <div class="table-container">
                        <table id="checklistSummaryTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Set Name</th>
                                    <th>Year</th>
                                    <th>Cards</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="empty-state">No checklists found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Card CSV Import Tab -->
                <div id="import-tab-cards" class="tab-content">
                    <p style="color: var(--bb-text-secondary); margin-bottom: var(--spacing-6);">Import cards from CSV file</p>

                    <div class="form-group">
                        <label class="form-label">Select CSV File</label>
                        <input type="file" id="cardCsvFile" accept=".csv" class="form-input" onchange="handleCardCsvUpload(event)">
                    </div>

                    <div id="cardImportPreview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD CARD PAGE -->
    <div id="page-add" class="page">
        <div class="container">
            <div class="content-card">
                <h2>Add New Card</h2>

                <form id="cardForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-4);">
                        <div class="form-group">
                            <label class="form-label">Set Name</label>
                            <select id="set_name" class="form-select" required onchange="handleSetSelection()">
                                <option value="">Select a set</option>
                            </select>
                            <input type="text" id="set_name_manual" class="form-input" placeholder="Enter custom set name" style="display: none;" required>
                            <small style="color: var(--bb-text-secondary); font-size: var(--font-sm); margin-top: var(--spacing-1); display: block;">
                                Select from checklist or choose "+ Manual Entry" to type custom set
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Card Number</label>
                            <input type="text" id="card_number" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Player</label>
                            <input type="text" id="player" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Team</label>
                            <input type="text" id="team" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year</label>
                            <input type="text" id="year" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Variety</label>
                            <input type="text" id="variety" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Parallel</label>
                            <input type="text" id="parallel" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Numbered</label>
                            <input type="text" id="numbered" class="form-input" placeholder="e.g. /99">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Graded</label>
                            <input type="text" id="graded" class="form-input" placeholder="e.g. PSA 10">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Price Paid</label>
                            <input type="number" step="0.01" id="price_paid" class="form-input" placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Current Value</label>
                            <input type="number" step="0.01" id="current_value" class="form-input" placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Sold Price</label>
                            <input type="number" step="0.01" id="sold_price" class="form-input" placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" id="location" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" id="quantity" class="form-input" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="autograph">
                            <span>Autograph</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="notes" class="form-textarea" placeholder="Additional notes"></textarea>
                    </div>

                    <div style="display: flex; gap: var(--spacing-3);">
                        <button type="submit" class="btn btn-primary">Add Card</button>
                        <button type="button" class="btn btn-secondary" onclick="autoFillFromChecklist()">Auto-fill from Checklist</button>
                    </div>
                </form>

                <div id="varietySelector" style="margin-top: var(--spacing-6);"></div>
            </div>
        </div>
    </div>

    <!-- COLLECTION PAGE -->
    <div id="page-collection" class="page">
        <div class="container">
            <div class="content-card">
                <h2>Card Collection</h2>

                <!-- Control Bar -->
                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-4); margin-bottom: var(--spacing-6); padding-bottom: var(--spacing-4); border-bottom: 1px solid var(--bb-border-subtle);">
                    <!-- Group By -->
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label" style="margin-bottom: var(--spacing-2);">Group By</label>
                        <select id="groupBySelect" class="form-select" onchange="applyGroupingAndSorting()">
                            <option value="none">No Grouping</option>
                            <option value="player" selected>Player</option>
                            <option value="set">Set</option>
                            <option value="year">Year</option>
                            <option value="team">Team</option>
                            <option value="variety">Variety</option>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label" style="margin-bottom: var(--spacing-2);">Sort By</label>
                        <select id="sortBySelect" class="form-select" onchange="applyGroupingAndSorting()">
                            <option value="name">Name (A-Z)</option>
                            <option value="value-desc">Value (High-Low)</option>
                            <option value="value-asc">Value (Low-High)</option>
                            <option value="date-desc">Recently Added</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="count-desc">Count (High-Low)</option>
                        </select>
                    </div>

                    <!-- View Mode -->
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label" style="margin-bottom: var(--spacing-2);">View Mode</label>
                        <div style="display: flex; gap: var(--spacing-2);">
                            <button id="viewCompact" class="btn btn-sm btn-secondary" onclick="setViewMode('compact')" style="flex: 1;">Compact</button>
                            <button id="viewDetailed" class="btn btn-sm btn-secondary" onclick="setViewMode('detailed')" style="flex: 1;">Detailed</button>
                            <button id="viewCards" class="btn btn-sm btn-secondary" onclick="setViewMode('cards')" style="flex: 1;">Cards</button>
                        </div>
                    </div>
                </div>

                <!-- Stats Bar -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
                    <div style="color: var(--bb-text-secondary); font-size: var(--font-sm);">
                        Showing <span id="filteredCount" style="color: var(--bb-text-primary); font-weight: 600;">0</span> of
                        <span id="totalCollectionCount" style="color: var(--bb-text-primary); font-weight: 600;">0</span> cards
                        <span id="groupCount" style="margin-left: var(--spacing-4);"></span>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="toggleAllGroups()">
                        <span id="toggleAllText">Expand All</span>
                    </button>
                </div>

                <!-- Search -->
                <div class="search-container">
                    <input type="text" id="playerSearch" class="search-input" placeholder="Search cards">
                    <button id="clearSearch" class="search-clear">Clear</button>
                    <div id="searchSuggestions" class="search-suggestions" style="display: none;"></div>
                </div>

                <!-- Collection Display Container -->
                <div id="cardsContainer"></div>
            </div>
        </div>
    </div>

    <!-- PRICING PAGE -->
    <div id="page-pricing" class="page">
        <div class="container">
            <div class="content-card">
                <h2>Price Tracking</h2>
                <p style="color: var(--bb-text-secondary); margin-bottom: var(--spacing-6);">Track prices for up to 20 cards and check current market values</p>

                <!-- eBay API Rate Limit Display -->
                <div id="rateLimitDisplay" style="padding: var(--spacing-3); background: var(--bb-card-bg); border-radius: 8px; margin-bottom: var(--spacing-4); border-left: 3px solid var(--bb-accent);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>eBay API Usage Today:</strong>
                            <span id="apiCallsToday" style="color: var(--bb-accent); font-weight: 600;">0</span> /
                            <span id="apiCallsLimit">5000</span>
                        </div>
                        <div style="font-size: var(--font-sm); color: var(--bb-text-secondary);">
                            <span id="apiCallsRemaining">5000</span> remaining
                        </div>
                    </div>
                    <div style="margin-top: var(--spacing-2); background: var(--bb-bg); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="rateLimitBar" style="height: 100%; background: var(--bb-accent); width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="rateLimitWarning" style="margin-top: var(--spacing-2); font-size: var(--font-sm); color: var(--bb-warning); display: none;">
                        ⚠️ Approaching daily limit - use API calls conservatively
                    </div>
                </div>

                <div style="display: flex; gap: var(--spacing-3); margin-bottom: var(--spacing-6);">
                    <button class="btn btn-secondary" onclick="openManageTracking()">
                        Manage Tracked Cards (<span id="trackedCardCount">0</span>/20)
                    </button>
                    <button id="checkPricesBtn" class="btn btn-primary" onclick="checkTrackedPrices()">Check Prices</button>
                </div>

                <div id="priceResultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- SUGGESTIONS PAGE -->
    <div id="page-suggestions" class="page">
        <div class="container">
            <div class="content-card">
                <h2>Submit Feedback</h2>
                <p style="color: var(--bb-text-secondary); margin-bottom: var(--spacing-6);">Share your ideas and suggestions for improving BaseballBinder</p>

                <form id="suggestionForm">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="suggestionCategory" class="form-select" required>
                            <option value="">Select category</option>
                            <option value="feature">Feature Request</option>
                            <option value="bug">Bug Report</option>
                            <option value="improvement">Improvement</option>
                            <option value="ui">UI/UX</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="suggestionTitle" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="suggestionDescription" class="form-textarea" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email (optional)</label>
                        <input type="email" id="suggestionEmail" class="form-input">
                    </div>

                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ADMIN PAGE -->
    <div id="page-admin" class="page">
        <div class="container">
            <div class="content-card">
                <h2>Admin Panel</h2>

                <div class="tab-buttons">
                    <button id="tab-requests" class="tab-button active" onclick="switchAdminTab('requests')">Checklist Requests</button>
                    <button id="tab-suggestions" class="tab-button" onclick="switchAdminTab('suggestions')">User Suggestions</button>
                    <button id="tab-database" class="tab-button" onclick="switchAdminTab('database')">Database</button>
                </div>

                <!-- Requests Tab -->
                <div id="admin-tab-requests" class="tab-content active">
                    <div style="margin-bottom: var(--spacing-4);">
                        <label class="form-label">Filter by Status</label>
                        <select id="statusFilter" class="form-select" style="max-width: 200px;" onchange="loadChecklistRequests()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>

                    <div style="margin-bottom: var(--spacing-4); color: var(--bb-text-secondary); font-size: var(--font-sm);">
                        Total Requests: <span id="requestCount" style="color: var(--bb-text-primary); font-weight: 600;">0</span>
                    </div>

                    <div id="requestsTableContainer" class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Set Name</th>
                                    <th>Year</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="empty-state">No requests found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Suggestions Tab -->
                <div id="admin-tab-suggestions" class="tab-content">
                    <div style="margin-bottom: var(--spacing-4);">
                        <label class="form-label">Filter by Status</label>
                        <select id="suggestionStatusFilter" class="form-select" style="max-width: 200px;" onchange="loadSuggestions()">
                            <option value="">All Statuses</option>
                            <option value="new">New</option>
                            <option value="reviewing">Reviewing</option>
                            <option value="planned">Planned</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>

                    <div style="margin-bottom: var(--spacing-4); color: var(--bb-text-secondary); font-size: var(--font-sm);">
                        Total Suggestions: <span id="suggestionCount" style="color: var(--bb-text-primary); font-weight: 600;">0</span>
                    </div>

                    <div id="suggestionsTableContainer" class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="empty-state">No suggestions found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Database Tab -->
                <div id="admin-tab-database" class="tab-content">
                    <div style="margin-bottom: var(--spacing-4);">
                        <h3>Database Management</h3>
                        <p style="color: var(--bb-text-secondary); margin-bottom: var(--spacing-4);">
                            Manage your card collection database. Use these tools carefully as some actions cannot be undone.
                        </p>
                    </div>

                    <div class="content-card" style="background-color: var(--bb-surface-lighter); border: 2px solid var(--bb-red); padding: var(--spacing-4);">
                        <h4 style="color: var(--bb-red); margin-bottom: var(--spacing-3);">Danger Zone</h4>
                        <p style="color: var(--bb-text-secondary); margin-bottom: var(--spacing-4); font-size: var(--font-sm);">
                            This action will permanently delete all cards from your collection. This cannot be undone.
                        </p>
                        <button class="btn btn-danger" onclick="clearAllCards()" style="background-color: var(--bb-red);">
                            Clear All Cards
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REQUEST CHECKLIST MODAL -->
    <div id="requestChecklistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Checklist</h2>
            </div>
            <div class="modal-body">
                <form id="requestChecklistForm" onsubmit="submitChecklistRequest(event); return false;">
                    <div class="form-group">
                        <label class="form-label">Set Name</label>
                        <input type="text" id="req_set_name" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Year</label>
                        <input type="text" id="req_year" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Manufacturer</label>
                        <select id="req_manufacturer" class="form-select">
                            <option value="">Select manufacturer</option>
                            <option value="Topps">Topps</option>
                            <option value="Panini">Panini</option>
                            <option value="Bowman">Bowman</option>
                            <option value="Upper Deck">Upper Deck</option>
                            <option value="Leaf">Leaf</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email (optional)</label>
                        <input type="email" id="req_email" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="req_notes" class="form-textarea"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="req_priority" class="form-select">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRequestChecklistModal()">Cancel</button>
                <button type="submit" form="requestChecklistForm" class="btn btn-primary">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- EDIT CARD MODAL -->
    <div id="editCardModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Edit Card</h2>
            </div>
            <div class="modal-body">
                <form id="editCardForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4);">
                        <div class="form-group">
                            <label class="form-label">Set Name</label>
                            <input type="text" id="edit_set_name" class="form-input" readonly style="opacity: 0.6;">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Card Number</label>
                            <input type="text" id="edit_card_number" class="form-input" readonly style="opacity: 0.6;">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Player</label>
                            <input type="text" id="edit_player" class="form-input" readonly style="opacity: 0.6;">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Team</label>
                            <input type="text" id="edit_team" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Year</label>
                            <input type="text" id="edit_year" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Variety</label>
                            <input type="text" id="edit_variety" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Parallel</label>
                            <input type="text" id="edit_parallel" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Numbered</label>
                            <input type="text" id="edit_numbered" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Graded</label>
                            <input type="text" id="edit_graded" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Price Paid</label>
                            <input type="number" step="0.01" id="edit_price_paid" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Current Value</label>
                            <input type="number" step="0.01" id="edit_current_value" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" id="edit_location" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" id="edit_quantity" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="edit_autograph">
                            <span>Autograph</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="edit_notes" class="form-textarea"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditCardModal()">Cancel</button>
                <button type="submit" form="editCardForm" class="btn btn-primary">Update Card</button>
            </div>
        </div>
    </div>

    <!-- IMPORT PROGRESS MODAL -->
    <div id="importProgressModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Importing Cards</h2>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--spacing-4);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-2);">
                        <span id="progressText" style="font-size: var(--font-sm); color: var(--bb-text-secondary);">Processing...</span>
                        <span id="progressPercent" style="font-size: var(--font-sm); font-weight: 600; color: var(--bb-text-primary);">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <div style="display: flex; gap: var(--spacing-6); margin-bottom: var(--spacing-4);">
                    <div style="text-align: center;">
                        <div style="font-size: var(--font-xs); color: var(--bb-text-secondary); margin-bottom: var(--spacing-1);">Success</div>
                        <div id="successCount" style="font-size: var(--font-xl); font-weight: 700; color: var(--bb-success);">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: var(--font-xs); color: var(--bb-text-secondary); margin-bottom: var(--spacing-1);">Errors</div>
                        <div id="errorCount" style="font-size: var(--font-xl); font-weight: 700; color: var(--bb-error);">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: var(--font-xs); color: var(--bb-text-secondary); margin-bottom: var(--spacing-1);">Total</div>
                        <div id="totalCount" style="font-size: var(--font-xl); font-weight: 700; color: var(--bb-text-primary);">0</div>
                    </div>
                </div>

                <div id="currentCardInfo" style="display: none; padding: var(--spacing-3); background: var(--bb-bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--spacing-4);">
                    <div style="font-size: var(--font-xs); color: var(--bb-text-secondary); margin-bottom: var(--spacing-1);">Currently Processing</div>
                    <div id="currentCardText" style="font-size: var(--font-sm); color: var(--bb-text-primary); font-weight: 600;"></div>
                </div>

                <div id="errorLogContainer" style="display: none;">
                    <h3 style="font-size: var(--font-base); font-weight: 600; color: var(--bb-error); margin-bottom: var(--spacing-2);">Errors</h3>
                    <div id="errorLog" style="max-height: 200px; overflow-y: auto; padding: var(--spacing-3); background: var(--bb-bg-tertiary); border: 1px solid var(--bb-border-subtle); border-radius: var(--radius-md); font-size: var(--font-sm);"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeImportBtn" class="btn btn-primary" onclick="closeImportProgress()" disabled>Close</button>
            </div>
        </div>
    </div>

    <!-- MISSING FIELD MODAL -->
    <div id="missingFieldModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Missing Fields</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--spacing-4); color: var(--bb-text-secondary);">This card is missing some information. You can fill in the fields below, add it anyway with missing data, or skip it.</p>

                <div id="missingFieldCardInfo" style="padding: var(--spacing-4); background: var(--bb-bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--spacing-4);"></div>

                <form id="missingFieldForm">
                    <div id="missingFieldInputs"></div>
                </form>
            </div>
            <div class="modal-footer" style="display: flex; gap: var(--spacing-3); justify-content: space-between;">
                <button class="btn btn-secondary" onclick="skipMissingFieldCard()">Skip This Card</button>
                <div style="display: flex; gap: var(--spacing-3);">
                    <button class="btn btn-secondary" onclick="addCardAnyways()">Add Anyways</button>
                    <button class="btn btn-primary" onclick="submitMissingFields()">Add Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MANAGE TRACKING MODAL -->
    <div id="manageTrackingModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Manage Price Tracking</h2>
                <p style="color: var(--bb-text-secondary); font-size: var(--font-sm); margin-top: var(--spacing-2);">
                    Selected: <span id="selectedCountDisplay" style="color: var(--bb-text-primary); font-weight: 600;">0</span> / 20
                </p>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: var(--spacing-2); margin-bottom: var(--spacing-4);">
                    <button class="btn btn-sm btn-secondary" onclick="quickSelectMostValuable()">Select Most Valuable</button>
                    <button class="btn btn-sm btn-secondary" onclick="quickSelectRecentAdditions()">Select Recent</button>
                    <button class="btn btn-sm btn-secondary" onclick="clearAllSelections()">Clear All</button>
                </div>

                <div class="search-container">
                    <input type="text" id="modalSearch" class="search-input" placeholder="Search cards">
                </div>

                <div id="cardSelectionGrid" class="card-grid"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeManageTracking()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTrackedSelection()">Save Selection</button>
            </div>
        </div>
    </div>

    <!-- GENERIC MODAL -->
    <div id="genericModal" class="modal">
        <div class="modal-content">
            <div id="genericModalContent"></div>
        </div>
    </div>

    <!-- Update Notification Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: var(--spacing-6);">
                <div style="text-align: center; margin-bottom: var(--spacing-4);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-2);">🎉</div>
                    <h2 style="margin: 0; color: var(--bb-primary);">Update Available!</h2>
                </div>

                <div style="background: var(--bb-bg-tertiary); padding: var(--spacing-4); border-radius: var(--radius-md); margin-bottom: var(--spacing-4);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-2);">
                        <span style="font-weight: 500;">Current Version:</span>
                        <span id="currentVersion" style="color: var(--bb-text-secondary);">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 500;">New Version:</span>
                        <span id="latestVersion" style="color: var(--bb-accent); font-weight: 600;">-</span>
                    </div>
                </div>

                <div style="margin-bottom: var(--spacing-4);">
                    <h3 style="margin: 0 0 var(--spacing-2) 0; font-size: var(--font-md);">What's New:</h3>
                    <div id="releaseNotes" style="background: var(--bb-bg-secondary); padding: var(--spacing-3); border-radius: var(--radius-sm); max-height: 200px; overflow-y: auto; font-size: var(--font-sm); line-height: 1.6;">
                        Loading release notes...
                    </div>
                </div>

                <div style="display: flex; gap: var(--spacing-3); justify-content: center;">
                    <button id="downloadUpdateBtn" class="btn btn-primary" onclick="downloadUpdate()" style="flex: 1; max-width: 200px;">
                        <span>Download Update</span>
                    </button>
                    <button class="btn btn-secondary" onclick="dismissUpdate()" style="flex: 1; max-width: 200px;">
                        Remind Me Later
                    </button>
                </div>

                <div style="margin-top: var(--spacing-3); text-align: center; font-size: var(--font-sm); color: var(--bb-text-secondary);">
                    <span id="fileSizeInfo"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'http://localhost:8000';

        // Global State
        let allCards = [];
        let filteredCards = [];
        let editingCardId = null;
        let modalCards = [];
        let selectedCardIds = new Set();

        // Import State
        var importedCards = [];
        var currentImportIndex = 0;
        var importSuccessCount = 0;
        var importErrorCount = 0;
        var importErrors = [];
        var pendingCard = null;
        var importResolve = null;

        // Admin State
        const ADMIN_PASSWORD = "1234";
        let isAdminAuthenticated = false;

        // ================================
        // NAVIGATION
        // ================================
        function showPage(pageName, event) {
            // Remove active class from all pages and nav links
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            // Admin authentication
            if (pageName === 'admin' && !isAdminAuthenticated) {
                const password = prompt('Enter admin password:');
                if (password !== ADMIN_PASSWORD) {
                    showMessage('Incorrect password', 'error');
                    return;
                }
                isAdminAuthenticated = true;
                loadChecklistRequests();
            }

            // Show selected page
            document.getElementById(`page-${pageName}`).classList.add('active');

            // Add active class to the clicked nav link or find it by page name
            if (event?.target) {
                event.target.classList.add('active');
            } else {
                // Find the nav link that corresponds to this page
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.getAttribute('onclick')?.includes(`'${pageName}'`)) {
                        link.classList.add('active');
                    }
                });
            }

            // Load data for specific pages
            if (pageName === 'home') {
                loadStats();
                loadFunStats();
            } else if (pageName === 'collection') {
                loadCards();
            } else if (pageName === 'import') {
                loadChecklistSummary();
                loadImportedSets();
            } else if (pageName === 'add') {
                loadSetDropdown();
            } else if (pageName === 'pricing') {
                loadTrackedCount();
                loadRateLimitStats(); // Load eBay API usage stats
            } else if (pageName === 'admin') {
                loadChecklistRequests();
            }
        }

        // ================================
        // DASHBOARD STATS
        // ================================
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats/`);
                const stats = await response.json();

                document.getElementById('homeTotalCards').textContent = stats.total_cards;
                document.getElementById('homeTotalInvested').textContent = `$${stats.total_invested.toFixed(2)}`;
                document.getElementById('homeTotalValue').textContent = `$${stats.total_value.toFixed(2)}`;

                const profitLoss = stats.profit_loss;
                const profitLossEl = document.getElementById('homeProfitLoss');
                const changeEl = document.getElementById('homeProfitLossChange');

                // Only show profit/loss if we have eBay pricing data
                if (profitLoss === null || !stats.has_ebay_data) {
                    profitLossEl.textContent = '—';
                    changeEl.textContent = 'eBay API not configured';
                    changeEl.className = 'stat-change';
                } else {
                    profitLossEl.textContent = `$${Math.abs(profitLoss).toFixed(2)}`;

                    if (profitLoss > 0) {
                        changeEl.textContent = 'Positive return';
                        changeEl.className = 'stat-change positive';
                    } else if (profitLoss < 0) {
                        changeEl.textContent = 'Negative return';
                        changeEl.className = 'stat-change negative';
                    } else {
                        changeEl.textContent = 'Break even';
                        changeEl.className = 'stat-change';
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadFunStats() {
            try {
                const response = await fetch(`${API_URL}/cards/`);
                const cards = await response.json();

                if (cards.length === 0) return;

                // Most collected player
                const playerCounts = {};
                cards.forEach(card => {
                    playerCounts[card.player] = (playerCounts[card.player] || 0) + (card.quantity || 1);
                });
                const topPlayer = Object.entries(playerCounts).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('topPlayer').textContent = topPlayer[0];
                document.getElementById('topPlayerCount').textContent = `${topPlayer[1]} cards`;

                // Most collected team
                const teamCounts = {};
                cards.forEach(card => {
                    if (card.team) {
                        teamCounts[card.team] = (teamCounts[card.team] || 0) + (card.quantity || 1);
                    }
                });
                const topTeam = Object.entries(teamCounts).sort((a, b) => b[1] - a[1])[0];
                if (topTeam) {
                    document.getElementById('topTeam').textContent = topTeam[0];
                    document.getElementById('topTeamCount').textContent = `${topTeam[1]} cards`;
                }

                // Most collected set
                const setCounts = {};
                cards.forEach(card => {
                    setCounts[card.set_name] = (setCounts[card.set_name] || 0) + (card.quantity || 1);
                });
                const topSet = Object.entries(setCounts).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('topSet').textContent = topSet[0];
                document.getElementById('topSetCount').textContent = `${topSet[1]} cards`;

                // Most valuable card
                const mostValuable = cards.reduce((max, card) =>
                    (card.current_value || 0) > (max.current_value || 0) ? card : max
                );
                document.getElementById('mostValuableCard').textContent = mostValuable.player;
                document.getElementById('mostValuableValue').textContent = `$${(mostValuable.current_value || 0).toFixed(2)}`;

                // Average card value
                const totalValue = cards.reduce((sum, card) => sum + (card.current_value || 0), 0);
                const avgValue = totalValue / cards.length;
                document.getElementById('avgCardValue').textContent = `$${avgValue.toFixed(2)}`;

                // Total autographs
                const autographCount = cards.filter(card => card.autograph).reduce((sum, card) => sum + (card.quantity || 1), 0);
                const autographPercent = (autographCount / cards.length * 100).toFixed(1);
                document.getElementById('totalAutographs').textContent = autographCount;
                document.getElementById('autographPercent').textContent = `${autographPercent}% of collection`;
            } catch (error) {
                console.error('Error loading fun stats:', error);
            }
        }

        // ================================
        // COLLECTION MANAGEMENT
        // ================================
        async function loadCards() {
            try {
                const response = await fetch(`${API_URL}/cards/`);
                allCards = await response.json();
                filteredCards = allCards;
                displayCards(allCards);

                document.getElementById('totalCollectionCount').textContent = allCards.length;
                document.getElementById('filteredCount').textContent = filteredCards.length;
            } catch (error) {
                console.error('Error loading cards:', error);
            }
        }

        // Collection View State
        let currentViewMode = 'compact';
        let expandedGroups = new Set();

        function displayCards(cards) {
            applyGroupingAndSorting();
        }

        function setViewMode(mode) {
            currentViewMode = mode;

            // Update button states
            document.querySelectorAll('[id^="view"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            document.getElementById(`view${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.remove('btn-secondary');
            document.getElementById(`view${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('btn-primary');

            applyGroupingAndSorting();
        }

        function applyGroupingAndSorting() {
            const groupBy = document.getElementById('groupBySelect').value;
            const sortBy = document.getElementById('sortBySelect').value;

            let cardsToDisplay = [...filteredCards];

            // Apply sorting
            cardsToDisplay = sortCards(cardsToDisplay, sortBy);

            // Apply grouping or show flat list
            if (groupBy === 'none') {
                displayFlatView(cardsToDisplay);
            } else {
                displayGroupedView(cardsToDisplay, groupBy);
            }
        }

        function sortCards(cards, sortBy) {
            const sorted = [...cards];

            switch(sortBy) {
                case 'name':
                    return sorted.sort((a, b) => (a.player || '').localeCompare(b.player || ''));
                case 'value-desc':
                    return sorted.sort((a, b) => (b.current_value || 0) - (a.current_value || 0));
                case 'value-asc':
                    return sorted.sort((a, b) => (a.current_value || 0) - (b.current_value || 0));
                case 'date-desc':
                    return sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                case 'date-asc':
                    return sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                default:
                    return sorted;
            }
        }

        function displayFlatView(cards) {
            const container = document.getElementById('cardsContainer');

            if (cards.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No cards found</div></div>';
                return;
            }

            if (currentViewMode === 'detailed') {
                displayDetailedTable(cards, container);
            } else if (currentViewMode === 'compact') {
                displayCompactList(cards, container);
            } else {
                displayCardGrid(cards, container);
            }
        }

        function displayGroupedView(cards, groupBy) {
            const container = document.getElementById('cardsContainer');

            if (cards.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No cards found</div></div>';
                return;
            }

            // Group cards
            const groups = {};
            cards.forEach(card => {
                let groupKey = card[groupBy] || 'Unknown';
                if (groupBy === 'set') groupKey = card.set_name || 'Unknown';

                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(card);
            });

            // Sort groups by name or count
            const sortBy = document.getElementById('sortBySelect').value;
            let groupEntries = Object.entries(groups);

            if (sortBy === 'count-desc') {
                groupEntries.sort((a, b) => b[1].length - a[1].length);
            } else {
                groupEntries.sort((a, b) => a[0].localeCompare(b[0]));
            }

            // Update group count
            document.getElementById('groupCount').textContent = `in ${groupEntries.length} groups`;

            // Render groups
            let html = '';
            groupEntries.forEach(([groupName, groupCards]) => {
                const totalValue = groupCards.reduce((sum, card) => sum + (card.current_value || 0), 0);
                const totalPaid = groupCards.reduce((sum, card) => sum + (card.price_paid || 0), 0);
                const isExpanded = expandedGroups.has(groupName);

                html += `
                    <div class="group-container">
                        <div class="group-header ${isExpanded ? 'expanded' : ''}" onclick="toggleGroup('${escapeHtml(groupName)}')">
                            <div>
                                <div class="group-title">${groupName}</div>
                            </div>
                            <div class="group-meta">
                                <div class="group-stat">
                                    <span>Cards:</span>
                                    <span class="group-stat-value">${groupCards.length}</span>
                                </div>
                                <div class="group-stat">
                                    <span>Paid:</span>
                                    <span class="group-stat-value">$${totalPaid.toFixed(2)}</span>
                                </div>
                                <div class="group-stat">
                                    <span>Value:</span>
                                    <span class="group-stat-value">$${totalValue.toFixed(2)}</span>
                                </div>
                                <div class="group-expand-icon">›</div>
                            </div>
                        </div>
                        <div class="group-content ${isExpanded ? 'expanded' : ''}" id="group-${escapeHtml(groupName)}">
                `;

                // Render cards within group based on view mode
                if (currentViewMode === 'detailed') {
                    html += renderDetailedCards(groupCards);
                } else if (currentViewMode === 'compact') {
                    html += renderCompactCards(groupCards);
                } else {
                    html += renderCardGridCards(groupCards);
                }

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleGroup(groupName) {
            if (expandedGroups.has(groupName)) {
                expandedGroups.delete(groupName);
            } else {
                expandedGroups.add(groupName);
            }
            applyGroupingAndSorting();
        }

        function toggleAllGroups() {
            const groupBy = document.getElementById('groupBySelect').value;

            if (groupBy === 'none') return;

            if (expandedGroups.size > 0) {
                expandedGroups.clear();
                document.getElementById('toggleAllText').textContent = 'Expand All';
            } else {
                // Expand all groups
                const cards = filteredCards;
                const groups = {};
                cards.forEach(card => {
                    let groupKey = card[groupBy] || 'Unknown';
                    if (groupBy === 'set') groupKey = card.set_name || 'Unknown';
                    groups[groupKey] = true;
                });
                Object.keys(groups).forEach(key => expandedGroups.add(key));
                document.getElementById('toggleAllText').textContent = 'Collapse All';
            }

            applyGroupingAndSorting();
        }

        // Detailed Table View
        function displayDetailedTable(cards, container) {
            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Set</th>
                                <th>Number</th>
                                <th>Year</th>
                                <th>Variety</th>
                                <th>Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            cards.forEach(card => {
                html += `
                    <tr>
                        <td style="color: var(--bb-text-primary); font-weight: 600;">${card.player || '—'}</td>
                        <td>${card.set_name || '—'}</td>
                        <td>${card.card_number || '—'}</td>
                        <td>${card.year || '—'}</td>
                        <td>${card.variety || '—'}${card.parallel ? ' - ' + card.parallel : ''}</td>
                        <td style="color: var(--bb-text-primary); font-weight: 600;">$${(card.current_value || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editCard(${card.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderDetailedCards(cards) {
            let html = `
                <table class="data-table">
                    <tbody>
            `;

            cards.forEach(card => {
                html += `
                    <tr>
                        <td style="color: var(--bb-text-primary); font-weight: 600;">${card.player || '—'}</td>
                        <td>${card.set_name || '—'}</td>
                        <td>${card.card_number || '—'}</td>
                        <td>${card.year || '—'}</td>
                        <td>${card.variety || '—'}${card.parallel ? ' - ' + card.parallel : ''}</td>
                        <td style="color: var(--bb-text-primary); font-weight: 600;">$${(card.current_value || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editCard(${card.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        // Compact List View
        function displayCompactList(cards, container) {
            let html = '<div class="compact-card-list">';

            cards.forEach(card => {
                // Build card details with clearer formatting
                let details = [];
                if (card.set_name) details.push(card.set_name);
                if (card.card_number) details.push(`#${card.card_number}`);
                if (card.year) details.push(card.year);
                if (card.variety && card.variety !== 'Base') details.push(card.variety);
                if (card.parallel) details.push(card.parallel);
                if (card.autograph) details.push('AUTO');
                if (card.numbered) details.push(`/${card.numbered}`);

                html += `
                    <div class="compact-card">
                        <div class="compact-card-info">
                            <div class="compact-card-title">${card.player || 'Unknown Player'}</div>
                            <div class="compact-card-details">
                                ${details.join(' • ')}
                            </div>
                        </div>
                        <div class="compact-card-value" style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <div style="font-size: var(--font-sm); color: var(--bb-text-secondary);">Paid: $${(card.price_paid || 0).toFixed(2)}</div>
                            <div style="font-weight: 600; color: var(--bb-text-primary);">Value: $${(card.current_value || 0).toFixed(2)}</div>
                        </div>
                        <div class="compact-card-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editCard(${card.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})">Delete</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderCompactCards(cards) {
            let html = '<div class="compact-card-list">';

            cards.forEach(card => {
                // Build card details with clearer formatting
                let details = [];
                if (card.set_name) details.push(card.set_name);
                if (card.card_number) details.push(`#${card.card_number}`);
                if (card.year) details.push(card.year);
                if (card.variety && card.variety !== 'Base') details.push(card.variety);
                if (card.parallel) details.push(card.parallel);
                if (card.autograph) details.push('AUTO');
                if (card.numbered) details.push(`/${card.numbered}`);

                // Show eBay price info if available
                let ebayPriceInfo = '';
                if (card.ebay_avg_price) {
                    ebayPriceInfo = `<div style="font-size: var(--font-sm); color: var(--bb-accent);">eBay Avg: $${card.ebay_avg_price.toFixed(2)}</div>`;
                }

                html += `
                    <div class="compact-card" id="card-${card.id}">
                        <div class="compact-card-info">
                            <div class="compact-card-title">${card.player || 'Unknown Player'}</div>
                            <div class="compact-card-details">
                                ${details.join(' • ')}
                            </div>
                        </div>
                        <div class="compact-card-value" style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <div style="font-size: var(--font-sm); color: var(--bb-text-secondary);">Paid: $${(card.price_paid || 0).toFixed(2)}</div>
                            <div style="font-weight: 600; color: var(--bb-text-primary);">Value: $${(card.current_value || 0).toFixed(2)}</div>
                            ${ebayPriceInfo}
                        </div>
                        <div class="compact-card-actions">
                            <button class="btn btn-sm btn-primary" onclick="checkEbayPrice(${card.id})" id="ebay-btn-${card.id}">Check eBay</button>
                            <button class="btn btn-sm btn-secondary" onclick="editCard(${card.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})">Delete</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // Card Grid View
        function displayCardGrid(cards, container) {
            let html = '<div class="card-view-grid">';

            cards.forEach(card => {
                html += `
                    <div class="visual-card" id="card-${card.id}">
                        <div class="visual-card-header">
                            <div class="visual-card-player">${card.player || 'Unknown Player'}</div>
                            <div class="visual-card-set">${card.set_name || 'Unknown Set'}</div>
                        </div>
                        <div class="visual-card-details">
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Number</span>
                                <span class="visual-card-detail-value">${card.card_number || '—'}</span>
                            </div>
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Year</span>
                                <span class="visual-card-detail-value">${card.year || '—'}</span>
                            </div>
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Variety</span>
                                <span class="visual-card-detail-value">${card.variety || '—'}</span>
                            </div>
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Team</span>
                                <span class="visual-card-detail-value">${card.team || '—'}</span>
                            </div>
                            ${card.ebay_avg_price ? `<div class="visual-card-detail">
                                <span class="visual-card-detail-label">eBay Avg</span>
                                <span class="visual-card-detail-value" style="color: var(--bb-accent);">$${card.ebay_avg_price.toFixed(2)}</span>
                            </div>` : ''}
                        </div>
                        <div class="visual-card-value">$${(card.current_value || 0).toFixed(2)}</div>
                        <div class="visual-card-actions">
                            <button class="btn btn-sm btn-primary" onclick="checkEbayPrice(${card.id})" id="ebay-btn-${card.id}" style="flex: 1;">Check eBay</button>
                            <button class="btn btn-sm btn-secondary" onclick="editCard(${card.id})" style="flex: 1;">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderCardGridCards(cards) {
            let html = '<div class="card-view-grid">';

            cards.forEach(card => {
                html += `
                    <div class="visual-card">
                        <div class="visual-card-header">
                            <div class="visual-card-player">${card.player || 'Unknown Player'}</div>
                            <div class="visual-card-set">${card.set_name || 'Unknown Set'}</div>
                        </div>
                        <div class="visual-card-details">
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Number</span>
                                <span class="visual-card-detail-value">${card.card_number || '—'}</span>
                            </div>
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Year</span>
                                <span class="visual-card-detail-value">${card.year || '—'}</span>
                            </div>
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Variety</span>
                                <span class="visual-card-detail-value">${card.variety || '—'}</span>
                            </div>
                            <div class="visual-card-detail">
                                <span class="visual-card-detail-label">Team</span>
                                <span class="visual-card-detail-value">${card.team || '—'}</span>
                            </div>
                        </div>
                        <div class="visual-card-value">$${(card.current_value || 0).toFixed(2)}</div>
                        <div class="visual-card-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editCard(${card.id})" style="flex: 1;">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCard(${card.id})" style="flex: 1;">Delete</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function editCard(id) {
            try {
                const response = await fetch(`${API_URL}/cards/${id}`);
                const card = await response.json();

                editingCardId = id;

                // Fill form
                document.getElementById('edit_set_name').value = card.set_name || '';
                document.getElementById('edit_card_number').value = card.card_number || '';
                document.getElementById('edit_player').value = card.player || '';
                document.getElementById('edit_team').value = card.team || '';
                document.getElementById('edit_year').value = card.year || '';
                document.getElementById('edit_variety').value = card.variety || '';
                document.getElementById('edit_parallel').value = card.parallel || '';
                document.getElementById('edit_numbered').value = card.numbered || '';
                document.getElementById('edit_graded').value = card.graded || '';
                document.getElementById('edit_price_paid').value = card.price_paid || '';
                document.getElementById('edit_current_value').value = card.current_value || '';
                document.getElementById('edit_location').value = card.location || '';
                document.getElementById('edit_quantity').value = card.quantity || 1;
                document.getElementById('edit_autograph').checked = card.autograph || false;
                document.getElementById('edit_notes').value = card.notes || '';

                document.getElementById('editCardModal').classList.add('active');
            } catch (error) {
                console.error('Error loading card:', error);
                showMessage('Error loading card', 'error');
            }
        }

        function closeEditCardModal() {
            document.getElementById('editCardModal').classList.remove('active');
            editingCardId = null;
        }

        async function deleteCard(id) {
            if (!confirm('Are you sure you want to delete this card?')) return;

            try {
                await fetch(`${API_URL}/cards/${id}`, { method: 'DELETE' });
                showMessage('Card deleted successfully', 'success');
                loadCards();
            } catch (error) {
                console.error('Error deleting card:', error);
                showMessage('Error deleting card', 'error');
            }
        }

        // ================================
        // SEARCH FUNCTIONALITY
        // ================================
        function handleSearchInput(e) {
            const query = e.target.value.toLowerCase();

            if (!query) {
                filteredCards = allCards;
                displayCards(allCards);
                document.getElementById('searchSuggestions').style.display = 'none';
                document.getElementById('filteredCount').textContent = allCards.length;
                return;
            }

            filteredCards = allCards.filter(card =>
                card.player.toLowerCase().includes(query)
            );

            displayCards(filteredCards);
            document.getElementById('filteredCount').textContent = filteredCards.length;
        }

        function clearSearch() {
            document.getElementById('playerSearch').value = '';
            filteredCards = allCards;
            displayCards(allCards);
            document.getElementById('filteredCount').textContent = allCards.length;
        }

        // ================================
        // CHECKLIST MANAGEMENT
        // ================================
        async function loadChecklistSummary() {
            try {
                const response = await fetch(`${API_URL}/checklist/summary`);
                const checklists = await response.json();

                const table = document.querySelector('#checklistSummaryTable tbody');

                if (checklists.length === 0) {
                    table.innerHTML = '<tr><td colspan="3" class="empty-state">No checklists found</td></tr>';
                    return;
                }

                let html = '';
                checklists.forEach(checklist => {
                    html += `
                        <tr>
                            <td style="color: var(--bb-text-primary); font-weight: 600;">${checklist.set_name}</td>
                            <td>${checklist.year}</td>
                            <td>${checklist.card_count}</td>
                        </tr>
                    `;
                });

                table.innerHTML = html;
            } catch (error) {
                console.error('Error loading checklists:', error);
            }
        }

        async function rescanChecklists() {
            try {
                const response = await fetch(`${API_URL}/checklist/rescan`, { method: 'POST' });
                const result = await response.json();
                showMessage(result.message, 'success');
                loadChecklistSummary();
            } catch (error) {
                console.error('Error rescanning:', error);
                showMessage('Error rescanning checklists', 'error');
            }
        }

        // ================================
        // GENERIC MODAL FUNCTIONS
        // ================================
        function showModal(htmlContent) {
            const modalContent = document.getElementById('genericModalContent');
            modalContent.innerHTML = htmlContent;
            document.getElementById('genericModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('genericModal').classList.remove('active');
            document.getElementById('genericModalContent').innerHTML = '';
        }

        function openRequestChecklistModal() {
            document.getElementById('requestChecklistModal').classList.add('active');
        }

        function closeRequestChecklistModal() {
            document.getElementById('requestChecklistModal').classList.remove('active');
            document.getElementById('requestChecklistForm').reset();
        }

        async function submitChecklistRequest(event) {
            event.preventDefault();

            const data = {
                set_name: document.getElementById('req_set_name').value,
                year: document.getElementById('req_year').value,
                manufacturer: document.getElementById('req_manufacturer').value || null,
                email: document.getElementById('req_email').value || null,
                notes: document.getElementById('req_notes').value || null,
                priority: document.getElementById('req_priority').value
            };

            try {
                await fetch(`${API_URL}/checklist/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                showMessage('Request submitted successfully', 'success');
                closeRequestChecklistModal();
            } catch (error) {
                console.error('Error submitting request:', error);
                showMessage('Error submitting request', 'error');
            }
        }

        // ================================
        // IMPORT FUNCTIONALITY
        // ================================
        function switchImportTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`import-tab-${tabName}`).classList.add('active');
        }

        async function handleCardCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const text = await file.text();
            parseAndPreviewCards(text);
        }

        function parseAndPreviewCards(csvText) {
            const lines = csvText.trim().split('\n');
            const errors = [];
            importedCards = [];

            // Skip header
            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = parseCSVLine(lines[i]);

                    // Updated column mapping to match user's CSV format:
                    // A: Set Name, B: Card Number, C: Player, D: Team, E: Year,
                    // F: Variety, G: Parallel, H: Autograph, I: Numbered, J: Graded, K: Price Paid
                    const card = {
                        set_name: values[0] || null,          // Column A
                        card_number: values[1] || null,       // Column B
                        player: values[2] || null,            // Column C
                        team: values[3] || null,              // Column D
                        year: values[4] || null,              // Column E
                        variety: values[5] || null,           // Column F
                        parallel: values[6] || null,          // Column G
                        autograph: values[7]?.toLowerCase() === 'yes' || values[7]?.toLowerCase() === 'true',  // Column H
                        numbered: values[8] || null,          // Column I
                        graded: values[9] || null,            // Column J
                        price_paid: values[10] ? parseFloat(values[10].replace(/[$,]/g, '')) : null,  // Column K
                        current_value: values[11] ? parseFloat(values[11].replace(/[$,]/g, '')) : null,  // Column L (if exists)
                        location: values[12] || null,         // Column M (if exists)
                        quantity: values[13] ? parseInt(values[13]) : 1,  // Column N (if exists)
                        notes: values[14] || null             // Column O (if exists)
                    };

                    importedCards.push(card);

                    // Check for missing fields
                    const missingFields = [];
                    if (!card.card_number || card.card_number.trim() === '') missingFields.push('Card Number');
                    if (!card.player || card.player.trim() === '') missingFields.push('Player');

                    if (missingFields.length > 0) {
                        errors.push(`Row ${i + 1}: Missing ${missingFields.join(', ')} - you'll be prompted during import`);
                    }
                } catch (error) {
                    console.error('Error parsing row', i + 1, ':', error);
                    errors.push(`Row ${i + 1}: ${error.message}`);
                }
            }

            displayImportPreview(importedCards, errors);
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            values.push(current.trim());
            return values;
        }

        function displayImportPreview(cards, errors) {
            const container = document.getElementById('cardImportPreview');

            let html = `
                <div class="import-preview">
                    <div class="import-stats">
                        <div class="import-stat">Total Cards: <strong>${cards.length}</strong></div>
                        <div class="import-stat">Warnings: <strong>${errors.length}</strong></div>
                    </div>

                    ${errors.length > 0 ? `
                        <div style="margin-bottom: var(--spacing-4); padding: var(--spacing-3); background: var(--bb-bg-tertiary); border-left: 3px solid var(--bb-warning); border-radius: var(--radius-md); font-size: var(--font-sm);">
                            ${errors.slice(0, 5).map(err => `<div>${err}</div>`).join('')}
                            ${errors.length > 5 ? `<div>... and ${errors.length - 5} more warnings</div>` : ''}
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: var(--spacing-3);">
                        <button class="btn btn-primary" onclick="importCards()">Import ${cards.length} Cards</button>
                        <button class="btn btn-secondary" onclick="cancelImport()">Cancel</button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        async function importCards() {
            if (importedCards.length === 0) {
                showMessage('No cards to import', 'error');
                return;
            }

            // Show progress modal
            document.getElementById('importProgressModal').classList.add('active');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressText').textContent = 'Starting import...';
            document.getElementById('successCount').textContent = '0';
            document.getElementById('errorCount').textContent = '0';
            document.getElementById('totalCount').textContent = importedCards.length;
            document.getElementById('closeImportBtn').disabled = true;

            importSuccessCount = 0;
            importErrorCount = 0;
            importErrors = [];

            for (let i = 0; i < importedCards.length; i++) {
                currentImportIndex = i;
                const card = importedCards[i];

                // Update progress
                const progress = Math.round(((i + 1) / importedCards.length) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercent').textContent = progress + '%';
                document.getElementById('progressText').textContent = `Processing card ${i + 1} of ${importedCards.length}`;

                // Show current card
                document.getElementById('currentCardInfo').style.display = 'block';
                document.getElementById('currentCardText').textContent = `${card.player} - ${card.set_name} #${card.card_number}`;

                // Check for missing required fields
                const missingFields = [];
                if (!card.card_number || card.card_number.trim() === '') missingFields.push('card_number');
                if (!card.player || card.player.trim() === '') missingFields.push('player');

                if (missingFields.length > 0) {
                    const result = await promptForMissingFields(card, missingFields, i + 1);

                    if (result === 'skip') {
                        importErrorCount++;
                        importErrors.push(`Row ${i + 1}: Skipped - missing required fields`);
                        document.getElementById('errorCount').textContent = importErrorCount;
                        continue;
                    } else if (result === 'addAnyways') {
                        // Continue with import without modifying card data
                    } else if (result) {
                        Object.assign(card, result);
                    }
                }

                // Import the card
                try {
                    const response = await fetch(`${API_URL}/cards/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(card)
                    });

                    if (!response.ok) throw new Error('Import failed');

                    importSuccessCount++;
                    document.getElementById('successCount').textContent = importSuccessCount;
                } catch (error) {
                    importErrorCount++;
                    importErrors.push(`Row ${i + 1}: ${error.message}`);
                    document.getElementById('errorCount').textContent = importErrorCount;
                }
            }

            // Show completion
            document.getElementById('currentCardInfo').style.display = 'none';
            document.getElementById('progressText').textContent = 'Import complete';
            document.getElementById('closeImportBtn').disabled = false;

            if (importErrors.length > 0) {
                document.getElementById('errorLogContainer').style.display = 'block';
                document.getElementById('errorLog').innerHTML = importErrors.map(err => `<div>${err}</div>`).join('');
            }

            showMessage(`Import complete: ${importSuccessCount} success, ${importErrorCount} errors`, 'success');
        }

        function promptForMissingFields(card, missingFields, rowNumber) {
            return new Promise((resolve) => {
                importResolve = resolve;
                pendingCard = card;

                // Build card info display
                let cardInfo = `<strong>Row ${rowNumber}:</strong> `;
                if (card.player) cardInfo += card.player;
                if (card.set_name) cardInfo += ` - ${card.set_name}`;
                if (card.card_number) cardInfo += ` #${card.card_number}`;
                document.getElementById('missingFieldCardInfo').innerHTML = cardInfo;

                // Build input fields
                let inputsHtml = '';
                const labels = {
                    'set_name': 'Set Name',
                    'card_number': 'Card Number',
                    'player': 'Player Name'
                };

                missingFields.forEach(field => {
                    inputsHtml += `
                        <div class="form-group">
                            <label class="form-label">${labels[field]}</label>
                            <input type="text" id="missing_${field}" class="form-input" required>
                        </div>
                    `;
                });

                document.getElementById('missingFieldInputs').innerHTML = inputsHtml;
                document.getElementById('missingFieldModal').classList.add('active');
            });
        }

        function submitMissingFields() {
            const missingData = {};

            ['set_name', 'card_number', 'player'].forEach(field => {
                const input = document.getElementById('missing_' + field);
                if (input) {
                    const value = input.value.trim();
                    if (value) {
                        missingData[field] = value;
                    }
                }
            });

            // Validate required fields are filled
            const stillMissing = [];
            if (!pendingCard.set_name && !missingData.set_name) stillMissing.push('Set Name');
            if (!pendingCard.card_number && !missingData.card_number) stillMissing.push('Card Number');
            if (!pendingCard.player && !missingData.player) stillMissing.push('Player');

            if (stillMissing.length > 0) {
                alert('Please fill in all required fields: ' + stillMissing.join(', '));
                return;
            }

            document.getElementById('missingFieldModal').classList.remove('active');
            if (importResolve) {
                importResolve(missingData);
                importResolve = null;
            }
        }

        function skipMissingFieldCard() {
            document.getElementById('missingFieldModal').classList.remove('active');
            if (importResolve) {
                importResolve('skip');
                importResolve = null;
            }
        }

        function addCardAnyways() {
            document.getElementById('missingFieldModal').classList.remove('active');
            if (importResolve) {
                importResolve('addAnyways');
                importResolve = null;
            }
        }

        function closeImportProgress() {
            document.getElementById('importProgressModal').classList.remove('active');
            loadCards();
        }

        function cancelImport() {
            importedCards = [];
            document.getElementById('cardImportPreview').innerHTML = '';
            document.getElementById('cardCsvFile').value = '';
        }

        // ================================
        // ADD CARD FUNCTIONALITY
        // ================================
        async function loadSetDropdown() {
            try {
                const response = await fetch(`${API_URL}/checklist/summary`);
                const sets = await response.json();

                const dropdown = document.getElementById('set_name');
                let html = '<option value="">Select a set</option>';

                const uniqueSets = [...new Set(sets.map(s => `${s.set_name} (${s.year})`))];
                uniqueSets.forEach(set => {
                    html += `<option value="${set}">${set}</option>`;
                });

                // Add manual entry option
                html += '<option value="" disabled>───────────────────</option>';
                html += '<option value="MANUAL_ENTRY">+ Manual Entry</option>';

                dropdown.innerHTML = html;
            } catch (error) {
                console.error('Error loading sets:', error);
            }
        }

        function handleSetSelection() {
            const dropdown = document.getElementById('set_name');
            const manualInput = document.getElementById('set_name_manual');

            if (dropdown.value === 'MANUAL_ENTRY') {
                // Switch to manual entry mode
                dropdown.style.display = 'none';
                dropdown.removeAttribute('required');
                manualInput.style.display = 'block';
                manualInput.setAttribute('required', 'required');
                manualInput.focus();
            } else {
                // Use dropdown mode
                dropdown.style.display = 'block';
                dropdown.setAttribute('required', 'required');
                manualInput.style.display = 'none';
                manualInput.removeAttribute('required');
            }
        }

        async function autoFillFromChecklist() {
            const setName = document.getElementById('set_name').value;
            const cardNumber = document.getElementById('card_number').value;
            const player = document.getElementById('player').value;

            if (!setName && !player) {
                showMessage('Please select a set or enter a player name', 'error');
                return;
            }

            try {
                let url;
                if (setName && cardNumber) {
                    url = `${API_URL}/checklist/lookup?set_name=${encodeURIComponent(setName)}&card_number=${encodeURIComponent(cardNumber)}`;
                } else if (player) {
                    url = `${API_URL}/checklist/search?player=${encodeURIComponent(player)}`;
                } else {
                    showMessage('Please provide either set name + card number or player name', 'error');
                    return;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    showMessage('Card not found in checklist', 'error');
                    return;
                }

                const data = await response.json();

                if (Array.isArray(data)) {
                    // Multiple results
                    showVarietySelector(data, []);
                } else {
                    // Single result
                    fillCardData(data);
                }
            } catch (error) {
                console.error('Error auto-filling:', error);
                showMessage('Error loading card data', 'error');
            }
        }

        function fillCardData(card) {
            if (card.player) document.getElementById('player').value = card.player;
            if (card.team) document.getElementById('team').value = card.team;
            if (card.year) document.getElementById('year').value = card.year;
            if (card.variety) document.getElementById('variety').value = card.variety;
            if (card.parallel) document.getElementById('parallel').value = card.parallel;
        }

        function showVarietySelector(cards, allParallels) {
            const container = document.getElementById('varietySelector');

            let html = `
                <div class="content-card">
                    <h3>Select Card Variety</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-3);">
            `;

            cards.forEach((card, idx) => {
                html += `
                    <div class="card-item" onclick="fillCardData(${JSON.stringify(card).replace(/"/g, '&quot;')})">
                        <div class="card-item-title">${card.variety || 'Base'}</div>
                        <div class="card-item-subtitle">${card.parallel || ''}</div>
                    </div>
                `;
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        // ================================
        // PRICE TRACKING
        // ================================
        async function loadRateLimitStats() {
            try {
                const response = await fetch(`${API_URL}/ebay/rate-limit-stats`);
                const stats = await response.json();

                document.getElementById('apiCallsToday').textContent = stats.count || 0;
                document.getElementById('apiCallsLimit').textContent = stats.limit || 5000;
                document.getElementById('apiCallsRemaining').textContent = stats.remaining || 5000;

                // Update progress bar
                const percentage = stats.percentage_used || 0;
                const bar = document.getElementById('rateLimitBar');
                bar.style.width = `${percentage}%`;

                // Change color based on usage
                if (percentage >= 80) {
                    bar.style.background = '#ef4444'; // Red
                    document.getElementById('rateLimitWarning').style.display = 'block';
                } else if (percentage >= 60) {
                    bar.style.background = '#f59e0b'; // Orange
                    document.getElementById('rateLimitWarning').style.display = 'none';
                } else {
                    bar.style.background = 'var(--bb-accent)'; // Blue
                    document.getElementById('rateLimitWarning').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading rate limit stats:', error);
            }
        }

        async function loadTrackedCount() {
            try {
                const response = await fetch(`${API_URL}/cards/tracked/`);
                const cards = await response.json();
                document.getElementById('trackedCardCount').textContent = cards.length;
            } catch (error) {
                console.error('Error loading tracked count:', error);
            }
        }

        async function openManageTracking() {
            try {
                const [allResponse, trackedResponse] = await Promise.all([
                    fetch(`${API_URL}/cards/`),
                    fetch(`${API_URL}/cards/tracked/`)
                ]);

                modalCards = await allResponse.json();
                const trackedCards = await trackedResponse.json();

                selectedCardIds = new Set(trackedCards.map(c => c.id));

                displayModalCards(modalCards);
                updateSelectionCounter();

                document.getElementById('manageTrackingModal').classList.add('active');
            } catch (error) {
                console.error('Error opening tracking modal:', error);
                showMessage('Error loading cards', 'error');
            }
        }

        function closeManageTracking() {
            document.getElementById('manageTrackingModal').classList.remove('active');
        }

        function displayModalCards(cards) {
            const container = document.getElementById('cardSelectionGrid');

            let html = '';
            cards.forEach(card => {
                const isSelected = selectedCardIds.has(card.id);
                html += `
                    <div class="card-item ${isSelected ? 'selected' : ''}" id="card-${card.id}" onclick="toggleCardSelection(${card.id}, event)">
                        <div class="card-item-title">${card.player}</div>
                        <div class="card-item-subtitle">${card.set_name} #${card.card_number}</div>
                        <div class="card-item-subtitle">$${(card.current_value || 0).toFixed(2)}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleCardSelection(cardId, event) {
            event.stopPropagation();

            if (selectedCardIds.has(cardId)) {
                selectedCardIds.delete(cardId);
                document.getElementById(`card-${cardId}`).classList.remove('selected');
            } else {
                if (selectedCardIds.size >= 20) {
                    showMessage('Maximum 20 cards can be tracked', 'error');
                    return;
                }
                selectedCardIds.add(cardId);
                document.getElementById(`card-${cardId}`).classList.add('selected');
            }

            updateSelectionCounter();
        }

        function updateSelectionCounter() {
            document.getElementById('selectedCountDisplay').textContent = selectedCardIds.size;
        }

        function quickSelectMostValuable() {
            const sorted = [...modalCards].sort((a, b) => (b.current_value || 0) - (a.current_value || 0));
            selectedCardIds = new Set(sorted.slice(0, 20).map(c => c.id));
            displayModalCards(modalCards);
            updateSelectionCounter();
        }

        function quickSelectRecentAdditions() {
            const sorted = [...modalCards].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            selectedCardIds = new Set(sorted.slice(0, 20).map(c => c.id));
            displayModalCards(modalCards);
            updateSelectionCounter();
        }

        function clearAllSelections() {
            selectedCardIds.clear();
            displayModalCards(modalCards);
            updateSelectionCounter();
        }

        async function saveTrackedSelection() {
            try {
                await fetch(`${API_URL}/cards/update-tracking`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_ids: Array.from(selectedCardIds) })
                });

                showMessage('Tracking selection saved', 'success');
                closeManageTracking();
                loadTrackedCount();
            } catch (error) {
                console.error('Error saving selection:', error);
                showMessage('Error saving selection', 'error');
            }
        }

        // ================================
        // EBAY PRICE CHECKING
        // ================================

        async function checkEbayPrice(cardId) {
            const button = document.getElementById(`ebay-btn-${cardId}`);
            const originalText = button.textContent;

            try {
                button.disabled = true;
                button.textContent = 'Checking...';

                const response = await fetch(`${API_URL}/cards/${cardId}/check-ebay-price`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to check eBay price');
                }

                const result = await response.json();

                // Show result modal
                showEbayPriceModal(result);

                // Reload cards to show updated price
                loadCards();

                // Update rate limit stats
                if (typeof loadRateLimitStats === 'function') loadRateLimitStats();

                showMessage(result.message, 'success');

            } catch (error) {
                console.error('Error checking eBay price:', error);
                showMessage(error.message || 'Error checking eBay price', 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        async function checkTrackedPrices() {
            const button = document.getElementById('checkPricesBtn');

            try {
                button.disabled = true;
                button.textContent = 'Checking prices...';

                showMessage('Checking prices for tracked cards (max 20)...', 'info');

                const response = await fetch(`${API_URL}/cards/check-tracked-prices`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to check prices');
                }

                const result = await response.json();

                // Display results
                displayBulkPriceResults(result);

                // Show summary message
                if (result.successful > 0) {
                    showMessage(`Successfully checked ${result.successful} of ${result.total_cards} cards`, 'success');
                } else {
                    showMessage('No prices were successfully checked', 'error');
                }

                // Reload cards to show updated prices
                if (typeof loadCards === 'function') loadCards();
                if (typeof loadStats === 'function') loadStats();

            } catch (error) {
                console.error('Error checking prices:', error);
                showMessage(error.message || 'Error checking prices', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Check Prices';
            }
        }

        function showEbayPriceModal(result) {
            const priceRange = result.min_price && result.max_price
                ? `$${result.min_price.toFixed(2)} - $${result.max_price.toFixed(2)}`
                : 'N/A';

            const avgPrice = result.avg_sold_price
                ? `$${result.avg_sold_price.toFixed(2)}`
                : 'N/A';

            let linksHtml = '';
            if (result.sample_urls && result.sample_urls.length > 0) {
                linksHtml = '<div style="margin-top: var(--spacing-3);"><strong>Sample Listings:</strong><ul style="margin-top: var(--spacing-2);">';
                result.sample_urls.forEach((url, idx) => {
                    linksHtml += `<li><a href="${url}" target="_blank" class="btn btn-sm btn-secondary" style="margin: 4px 0;">View Listing ${idx + 1}</a></li>`;
                });
                linksHtml += '</ul></div>';
            }

            // Show helpful message if no results in sandbox
            let noResultsMsg = '';
            if (result.listing_count === 0) {
                noResultsMsg = `
                    <div style="margin-top: var(--spacing-3); padding: var(--spacing-3); background: var(--bb-card-bg); border-left: 3px solid var(--bb-accent); border-radius: 4px;">
                        <strong style="color: var(--bb-accent);">ℹ️ No listings found</strong><br>
                        <span style="color: var(--bb-text-secondary); font-size: var(--font-sm);">
                            This is expected in <strong>sandbox mode</strong>. The eBay sandbox has limited test data.<br>
                            <em>Production mode will return real eBay pricing data.</em>
                        </span>
                    </div>
                `;
            }

            const modalContent = `
                <div style="padding: var(--spacing-4);">
                    <h3>eBay Price Check Results</h3>
                    <div style="margin-top: var(--spacing-4);">
                        <p><strong>Player:</strong> ${result.player}</p>
                        <p><strong>Search:</strong> ${result.search_keywords}</p>
                        <p><strong>Listings Found:</strong> ${result.listing_count}</p>
                        <p><strong>Average Sold Price:</strong> ${avgPrice}</p>
                        <p><strong>Price Range:</strong> ${priceRange}</p>
                        ${linksHtml}
                        ${noResultsMsg}
                        <p style="font-size: var(--font-sm); color: var(--bb-text-secondary); margin-top: var(--spacing-3);">
                            Last checked: ${new Date(result.last_checked).toLocaleString()}
                        </p>
                    </div>
                    <div style="margin-top: var(--spacing-4);">
                        <button class="btn btn-primary" onclick="closeModal()">Close</button>
                        ${result.avg_sold_price ? `<button class="btn btn-secondary" onclick="updateCardValueFromEbay(${result.card_id}, ${result.avg_sold_price})">Update Card Value</button>` : ''}
                    </div>
                </div>
            `;

            showModal(modalContent);
        }

        function displayBulkPriceResults(result) {
            const container = document.getElementById('priceResultsContainer');

            if (!result.results || result.results.length === 0) {
                container.innerHTML = '<div class="empty-state">No results found</div>';
                return;
            }

            let html = `
                <div class="content-card" style="margin-top: var(--spacing-4);">
                    <h3>Price Check Results</h3>
                    <div style="margin-bottom: var(--spacing-3); color: var(--bb-text-secondary);">
                        Checked ${result.total_cards} cards | Successful: ${result.successful} | Failed: ${result.failed}
                    </div>
            `;

            if (result.errors && result.errors.length > 0) {
                html += `
                    <div class="alert alert-warning" style="margin-bottom: var(--spacing-3);">
                        <strong>Errors:</strong>
                        <ul style="margin: var(--spacing-2) 0 0 var(--spacing-4);">
                            ${result.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Card</th>
                                <th>Avg Sold Price</th>
                                <th>Price Range</th>
                                <th>Listings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            result.results.forEach(item => {
                const priceRange = item.min_price && item.max_price
                    ? `$${item.min_price.toFixed(2)} - $${item.max_price.toFixed(2)}`
                    : 'N/A';

                const avgPrice = item.avg_sold_price
                    ? `$${item.avg_sold_price.toFixed(2)}`
                    : 'N/A';

                const sampleLink = item.sample_urls && item.sample_urls.length > 0
                    ? `<a href="${item.sample_urls[0]}" target="_blank" class="btn btn-sm btn-secondary">View on eBay</a>`
                    : '';

                html += `
                    <tr>
                        <td style="font-weight: 600;">${item.player}</td>
                        <td>${avgPrice}</td>
                        <td>${priceRange}</td>
                        <td>${item.listing_count}</td>
                        <td>
                            ${sampleLink}
                            ${item.avg_sold_price ? `<button class="btn btn-sm btn-primary" onclick="updateCardValueFromEbay(${item.card_id}, ${item.avg_sold_price})">Update Value</button>` : ''}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            </div>
            `;

            container.innerHTML = html;
        }

        async function updateCardValueFromEbay(cardId, ebayPrice) {
            try {
                const response = await fetch(`${API_URL}/cards/${cardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_value: ebayPrice
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update card value');
                }

                showMessage('Card value updated successfully', 'success');

                // Reload cards and stats
                if (typeof loadCards === 'function') loadCards();
                if (typeof loadStats === 'function') loadStats();

                // Close modal if open
                if (typeof closeModal === 'function') closeModal();

            } catch (error) {
                console.error('Error updating card value:', error);
                showMessage('Error updating card value', 'error');
            }
        }

        function displayPriceResults(results) {
            const container = document.getElementById('priceResultsContainer');
            window.currentPriceResults = results;

            if (results.length === 0) {
                container.innerHTML = '<div class="empty-state">No results found</div>';
                return;
            }

            let html = `
                <div class="content-card">
                    <h3>Price Check Results</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Card</th>
                                    <th>Current Value</th>
                                    <th>eBay Avg</th>
                                    <th>Range</th>
                                    <th>Link</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach(({ card, priceData }) => {
                html += `
                    <tr>
                        <td style="color: var(--bb-text-primary); font-weight: 600;">${card.player} - ${card.set_name} #${card.card_number}</td>
                        <td>$${(card.current_value || 0).toFixed(2)}</td>
                        <td>${priceData.avg_sold_price ? '$' + priceData.avg_sold_price.toFixed(2) : 'N/A'}</td>
                        <td>${priceData.price_range || 'N/A'}</td>
                        <td><a href="${priceData.ebay_url}" target="_blank" class="btn btn-sm btn-secondary">View on eBay</a></td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: var(--spacing-4);">
                        <button class="btn btn-primary" onclick="updateCardValuesFromResults()">Update Card Values</button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        async function updateCardValuesFromResults() {
            if (!window.currentPriceResults) {
                showMessage('No price results available', 'error');
                return;
            }

            const updates = window.currentPriceResults
                .filter(r => r.priceData.avg_sold_price !== null)
                .map(r => ({
                    card_id: r.card.id,
                    ebay_avg_price: r.priceData.avg_sold_price,
                    current_value: r.priceData.avg_sold_price
                }));

            if (updates.length === 0) {
                showMessage('No values to update', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/cards/bulk-update-values`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates })
                });

                showMessage(`Updated ${updates.length} card values`, 'success');
                loadCards();
            } catch (error) {
                console.error('Error updating values:', error);
                showMessage('Error updating card values', 'error');
            }
        }

        // ================================
        // ADMIN FUNCTIONALITY
        // ================================
        function switchAdminTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`admin-tab-${tabName}`).classList.add('active');

            if (tabName === 'requests') {
                loadChecklistRequests();
            } else if (tabName === 'suggestions') {
                loadSuggestions();
            }
        }

        async function loadChecklistRequests() {
            try {
                const filter = document.getElementById('statusFilter')?.value || '';
                const url = filter ? `${API_URL}/checklist/requests?status=${filter}` : `${API_URL}/checklist/requests`;

                const response = await fetch(url);
                const requests = await response.json();

                document.getElementById('requestCount').textContent = requests.length;

                const table = document.querySelector('#requestsTableContainer tbody');

                if (requests.length === 0) {
                    table.innerHTML = '<tr><td colspan="7" class="empty-state">No requests found</td></tr>';
                    return;
                }

                let html = '';
                requests.forEach(req => {
                    const statusColors = {
                        'pending': 'var(--bb-warning)',
                        'processing': 'var(--bb-info)',
                        'completed': 'var(--bb-success)',
                        'rejected': 'var(--bb-error)'
                    };

                    html += `
                        <tr>
                            <td>${req.id}</td>
                            <td style="color: var(--bb-text-primary); font-weight: 600;">${req.set_name}</td>
                            <td>${req.year}</td>
                            <td><span style="padding: 2px 8px; background: ${req.priority === 'high' ? 'var(--bb-error)' : 'var(--bb-info)'}; color: white; border-radius: 4px; font-size: var(--font-xs);">${req.priority}</span></td>
                            <td><span style="padding: 2px 8px; background: ${statusColors[req.status]}; color: white; border-radius: 4px; font-size: var(--font-xs);">${req.status}</span></td>
                            <td>${new Date(req.created_at).toLocaleDateString()}</td>
                            <td>
                                <select class="form-select" style="width: auto; padding: 4px 8px; font-size: var(--font-xs);" onchange="updateRequestStatus(${req.id}, this.value)">
                                    <option value="">Update Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="processing">Processing</option>
                                    <option value="completed">Completed</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });

                table.innerHTML = html;
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        async function updateRequestStatus(requestId, newStatus) {
            if (!newStatus) return;

            try {
                await fetch(`${API_URL}/checklist/requests/${requestId}/status?status=${newStatus}`, {
                    method: 'PATCH'
                });

                showMessage('Status updated', 'success');
                loadChecklistRequests();
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('Error updating status', 'error');
            }
        }

        async function loadSuggestions() {
            try {
                const filter = document.getElementById('suggestionStatusFilter')?.value || '';
                const url = filter ? `${API_URL}/checklist/suggestions?status=${filter}` : `${API_URL}/checklist/suggestions`;

                const response = await fetch(url);
                const suggestions = await response.json();

                document.getElementById('suggestionCount').textContent = suggestions.length;

                const table = document.querySelector('#suggestionsTableContainer tbody');

                if (suggestions.length === 0) {
                    table.innerHTML = '<tr><td colspan="6" class="empty-state">No suggestions found</td></tr>';
                    return;
                }

                let html = '';
                suggestions.forEach(sug => {
                    const statusColors = {
                        'new': 'var(--bb-info)',
                        'reviewing': 'var(--bb-warning)',
                        'planned': 'var(--bb-highlight)',
                        'completed': 'var(--bb-success)',
                        'rejected': 'var(--bb-error)'
                    };

                    html += `
                        <tr>
                            <td>${sug.id}</td>
                            <td style="color: var(--bb-text-primary); font-weight: 600;">${sug.title}</td>
                            <td><span style="padding: 2px 8px; background: var(--bb-bg-tertiary); color: var(--bb-text-primary); border-radius: 4px; font-size: var(--font-xs);">${sug.category}</span></td>
                            <td><span style="padding: 2px 8px; background: ${statusColors[sug.status]}; color: white; border-radius: 4px; font-size: var(--font-xs);">${sug.status}</span></td>
                            <td>${new Date(sug.created_at).toLocaleDateString()}</td>
                            <td>
                                <select class="form-select" style="width: auto; padding: 4px 8px; font-size: var(--font-xs);" onchange="updateSuggestionStatus(${sug.id}, this.value)">
                                    <option value="">Update Status</option>
                                    <option value="new">New</option>
                                    <option value="reviewing">Reviewing</option>
                                    <option value="planned">Planned</option>
                                    <option value="completed">Completed</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });

                table.innerHTML = html;
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        }

        async function updateSuggestionStatus(suggestionId, newStatus) {
            if (!newStatus) return;

            try {
                await fetch(`${API_URL}/checklist/suggestions/${suggestionId}/status?status=${newStatus}`, {
                    method: 'PATCH'
                });

                showMessage('Status updated', 'success');
                loadSuggestions();
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('Error updating status', 'error');
            }
        }

        async function clearAllCards() {
            const confirmed = confirm('⚠️ WARNING: This will permanently delete ALL cards from your collection. This action cannot be undone.\n\nAre you absolutely sure you want to continue?');

            if (!confirmed) return;

            const doubleConfirm = confirm('This is your final warning. Type "DELETE" in the next prompt to confirm.');

            if (!doubleConfirm) return;

            const typedConfirmation = prompt('Type DELETE (in all caps) to confirm deletion of all cards:');

            if (typedConfirmation !== 'DELETE') {
                showMessage('Deletion cancelled', 'info');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cards/`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                showMessage(`Successfully deleted ${result.deleted_count} card(s)`, 'success');

                // Refresh any data that might be showing cards
                if (typeof loadCards === 'function') loadCards();
                if (typeof loadStats === 'function') loadStats();
            } catch (error) {
                console.error('Error clearing cards:', error);
                showMessage('Error clearing cards', 'error');
            }
        }

        // ================================
        // SUGGESTIONS
        // ================================
        function setupSuggestionForm() {
            document.getElementById('suggestionForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const data = {
                    category: document.getElementById('suggestionCategory').value,
                    title: document.getElementById('suggestionTitle').value,
                    description: document.getElementById('suggestionDescription').value,
                    email: document.getElementById('suggestionEmail').value || null
                };

                try {
                    await fetch(`${API_URL}/checklist/suggestions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    showMessage('Feedback submitted successfully', 'success');
                    document.getElementById('suggestionForm').reset();
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    showMessage('Error submitting feedback', 'error');
                }
            });
        }

        // ================================
        // UTILITIES
        // ================================
        function showMessage(text, type = 'success') {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;

            container.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 4000);
        }

        async function loadImportedSets() {
            // Placeholder for any additional import functionality
            await loadSetDropdown();
        }

        // ================================
        // FORM HANDLERS
        // ================================
        document.getElementById('cardForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check if manual entry is being used
            const dropdown = document.getElementById('set_name');
            const manualInput = document.getElementById('set_name_manual');
            const setNameValue = (manualInput.style.display !== 'none' && manualInput.value)
                ? manualInput.value
                : dropdown.value;

            const data = {
                set_name: setNameValue || null,
                card_number: document.getElementById('card_number').value || null,
                player: document.getElementById('player').value || null,
                team: document.getElementById('team').value || null,
                year: document.getElementById('year').value || null,
                variety: document.getElementById('variety').value || null,
                parallel: document.getElementById('parallel').value || null,
                numbered: document.getElementById('numbered').value || null,
                graded: document.getElementById('graded').value || null,
                price_paid: document.getElementById('price_paid').value ? parseFloat(document.getElementById('price_paid').value) : null,
                current_value: document.getElementById('current_value').value ? parseFloat(document.getElementById('current_value').value) : null,
                sold_price: document.getElementById('sold_price').value ? parseFloat(document.getElementById('sold_price').value) : null,
                location: document.getElementById('location').value || null,
                quantity: parseInt(document.getElementById('quantity').value) || 1,
                autograph: document.getElementById('autograph').checked,
                notes: document.getElementById('notes').value || null
            };

            try {
                const method = editingCardId ? 'PUT' : 'POST';
                const url = editingCardId ? `${API_URL}/cards/${editingCardId}` : `${API_URL}/cards/`;

                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                showMessage(editingCardId ? 'Card updated successfully' : 'Card added successfully', 'success');
                document.getElementById('cardForm').reset();

                // Reset dropdown/manual input visibility
                const dropdown = document.getElementById('set_name');
                const manualInput = document.getElementById('set_name_manual');
                dropdown.style.display = 'block';
                dropdown.setAttribute('required', 'required');
                manualInput.style.display = 'none';
                manualInput.removeAttribute('required');
                manualInput.value = '';

                editingCardId = null;
                loadCards();
            } catch (error) {
                console.error('Error saving card:', error);
                showMessage('Error saving card', 'error');
            }
        });

        document.getElementById('editCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                set_name: document.getElementById('edit_set_name').value || null,
                card_number: document.getElementById('edit_card_number').value || null,
                player: document.getElementById('edit_player').value || null,
                team: document.getElementById('edit_team').value || null,
                year: document.getElementById('edit_year').value || null,
                variety: document.getElementById('edit_variety').value || null,
                parallel: document.getElementById('edit_parallel').value || null,
                numbered: document.getElementById('edit_numbered').value || null,
                graded: document.getElementById('edit_graded').value || null,
                price_paid: document.getElementById('edit_price_paid').value ? parseFloat(document.getElementById('edit_price_paid').value) : null,
                current_value: document.getElementById('edit_current_value').value ? parseFloat(document.getElementById('edit_current_value').value) : null,
                location: document.getElementById('edit_location').value || null,
                quantity: parseInt(document.getElementById('edit_quantity').value) || 1,
                autograph: document.getElementById('edit_autograph').checked,
                notes: document.getElementById('edit_notes').value || null
            };

            try {
                await fetch(`${API_URL}/cards/${editingCardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                showMessage('Card updated successfully', 'success');
                closeEditCardModal();
                loadCards();
            } catch (error) {
                console.error('Error updating card:', error);
                showMessage('Error updating card', 'error');
            }
        });

        // ================================
        // EVENT LISTENERS
        // ================================
        document.getElementById('playerSearch').addEventListener('input', handleSearchInput);
        document.getElementById('clearSearch').addEventListener('click', clearSearch);
        document.getElementById('modalSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = query
                ? modalCards.filter(card =>
                    card.player.toLowerCase().includes(query) ||
                    card.set_name.toLowerCase().includes(query)
                  )
                : modalCards;
            displayModalCards(filtered);
        });

        // ================================
        // INITIALIZATION
        // ================================
        // ================================
        // UPDATE SYSTEM
        // ================================

        let updateInfo = null;

        async function checkForUpdates() {
            try {
                const response = await fetch(`${API_URL}/version/check-update`);
                const data = await response.json();

                if (data.update_available && data.installer_url) {
                    updateInfo = data;
                    showUpdateNotification(data);
                }
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }

        function showUpdateNotification(data) {
            document.getElementById('currentVersion').textContent = `v${data.current_version}`;
            document.getElementById('latestVersion').textContent = `v${data.latest_version}`;

            // Format release notes
            let releaseNotes = data.release_notes || 'No release notes available.';

            // Convert markdown-style formatting to HTML
            releaseNotes = releaseNotes
                .replace(/###\s+(.+)/g, '<h4 style="margin: var(--spacing-2) 0;">$1</h4>')
                .replace(/##\s+(.+)/g, '<h3 style="margin: var(--spacing-3) 0;">$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^[-*]\s+(.+)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul style="margin: var(--spacing-2) 0; padding-left: var(--spacing-4);">$1</ul>')
                .replace(/\n\n/g, '<br><br>');

            document.getElementById('releaseNotes').innerHTML = releaseNotes;

            // Show file size if available
            if (data.file_size) {
                const sizeMB = (data.file_size / (1024 * 1024)).toFixed(2);
                document.getElementById('fileSizeInfo').textContent = `Download size: ${sizeMB} MB`;
            }

            document.getElementById('updateModal').classList.add('active');
        }

        function downloadUpdate() {
            if (updateInfo && updateInfo.installer_url) {
                // Open download URL in new window
                window.open(updateInfo.installer_url, '_blank');

                // Show message
                showMessage('Download started! Please install the update after download completes.', 'success');
                dismissUpdate();
            }
        }

        function dismissUpdate() {
            document.getElementById('updateModal').classList.remove('active');
            updateInfo = null;

            // Store dismissal time in localStorage (optional - to not show again for a day)
            localStorage.setItem('updateDismissed', Date.now());
        }

        function shouldCheckForUpdates() {
            const lastDismissed = localStorage.getItem('updateDismissed');
            if (!lastDismissed) return true;

            // Check again after 24 hours
            const dayInMs = 24 * 60 * 60 * 1000;
            return (Date.now() - parseInt(lastDismissed)) > dayInMs;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            setupSuggestionForm();
            setViewMode('compact'); // Initialize default view mode
            showPage('home');
            // Ensure dashboard stats load on initial page load
            await Promise.all([loadStats(), loadFunStats()]);

            // Check for updates on startup (after a short delay)
            if (shouldCheckForUpdates()) {
                setTimeout(() => checkForUpdates(), 2000);
            }

            // Close generic modal when clicking outside
            document.getElementById('genericModal').addEventListener('click', (e) => {
                if (e.target.id === 'genericModal') {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
